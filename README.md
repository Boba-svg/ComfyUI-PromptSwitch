# ComfyUI-PromptSwitch プロンプト作業を劇的に高速化！

プロンプトのON/OFF切り替えやウェイト調整を、チェックリストのように直感的に行えるカスタムノードです。

---

GitHubで公開された「PromptSwitch」へようこそ！  
これは、**Prompt Palette** のアイデアをベースに、**プロンプト管理と操作性を劇的に改善**したバージョンです。  
機能の起源を区別するために、以下のように表記しています。

- **[Original]**：Prompt Palette から受け継いだ基本機能  
- **[Switch]**：PromptSwitch で追加・改善された機能

---

## 主な機能

※画像は古い可能性があります。最新のショートカットは下記を参照してください

**ノードタイトルのタグの書式は / 区切りです**  
例：`/a /r /R0-4 /C /Compact`（`/ra` のような複合は無効）

### 1. インタラクティブなプロンプト管理
非編集モードでは、各行がチェックリストのように表示されます。

- **[Original]** 行のON/OFF切り替え（クリックで `//` 付与）  
- **[Original]** ウェイト調整（右側の `+` / `-` ボタンで 0.10 単位）  
- **[Switch]** 空行は薄い水色線で区切り表示（ランダムグループの区切りとしても機能）  
- **[Switch]** `//,//` → 灰色線で純粋なセパレータ  
- **[Switch]** `//,// コメント` → 水色文字でコメント表示  
- **[Switch]** 長い行は30文字+「...」で省略、コメントは80%サイズ・水色表示

### 2. モード切り替え
- **編集モード**：`F2` / `E` キー、またはノード枠ダブルクリック（上部ヘッダー以外）  
- **コンパクトモード**：`V` キー（無効行非表示）、`Shift+V` で全ノード一括切替（`/v` 除外）

---

## ショートカットキー（2025-11-22 最新版）

| キー         | 機能                             | 説明                                   |
|--------------|----------------------------------|----------------------------------------|
| `F1`         | ヘルプ表示                       | ショートカットとタグの説明             |
| `F2` / `E`   | 編集モード切替                   | 通常モード ↔ 編集モード                |
| `Shift+E`    | 全ノード編集モード一括切替       | 検索ワード強調が便利                   |
| `A`          | 選択ノード全行ON/OFFトグル       |                                        |
| `Shift+A`    | 全ノード強制無効化               | `/a` 除外                              |
| `V`          | コンパクトモード切替             | 無効行非表示                           |
| `Shift+V`    | 全ノード一括コンパクト切替       | `/v` 除外                              |
| `W`          | ウェイト全リセット               | 1.00 に戻す                            |
| `R`          | ランダムピックアップ             | 空行区切りセクションから選択           |
| `Shift+R`    | 全ノード一括ランダム             | `/r` 除外                              |
| `C`          | **/C タグのトグル**              | **生成ごとに自動ランダム更新のON/OFF** |
| `Shift+C`    | **全ノードから /C と /CM系を一括削除** |                                    |

---

## 最強の新機能：`/C` タグ（2025-11-15 完全決定版）

> **「RUN（実行）ボタンを押すたびに、自動でランダム更新」**

### 使い方（たった2ステップ）
1. ノードを選択して **Cキー** を押す → タイトルに `/C` が付く  
2. **「Generate」を押すだけ**

→ **押すたびに自動でランダムピックアップ**（**生成後も `/C` のまま残る**）

### `/C` タグの特徴（最新仕様）
- 毎回確実にランダム実行  
- **Cキー** で簡単にON/OFF  
- **Shift+C** で全ノード一括解除  
- **/Rタグと完全連携**（個数・外れ枠も自由）  
例：`表情 /R-8-2 /C` → 外れ枠8個 + 最大2個選択、生成ごとに自動で変化

### 連続生成との最強コンボ
[AutoBatchRunner](https://github.com/Boba-svg/ComfyUI-AutoBatchRunner) と組み合わせれば  
**1クリックで100回分、毎回違うプロンプトで生成** が可能！

---

## `/CMn-k` タグ（上級者向け・手動カウント）
- `/CM5` → 5回、今の有効化しているプロンプトで生成 → 6回目でランダムピックアップ  
- `/CM10-3` → 現在3回目  
- 生成時に自動で `/CM10-4` → … → `/CM10-1` に更新  
- **`/C` とは完全に独立**（併用不可、`/C` が優先）

---

## `/T` タグ（Turn: 順番に回る）【2025/11/14実装】
- `/T` → 1行目から順番に有効化  
- `/T5M3-2` → 5行目を3回実行中（現在2回目）  
- 空白行・`//`・`//,//` は自動スキップ  
- `/C`・`/CM` と競合 → **`/T` が優先**

---

## ワークフロー読み込み時に全ノードをコンパクトモードで起動（2025-11-22 新機能）
- タイトルに **`/Compact`**（大文字小文字問わず）を付けたノードが1つでもあれば、  
  ワークフロー読み込み時に **全PromptSwitchノードが自動でコンパクトモード** になります  
- `/v` タグで除外されたノードは従来通り対象外  
- 既存の `/v`（小文字）は個別トグル・Shift+V除外用として完全維持

---

## タグのルール（すべて / で区切る）

| タグ         | 意味                                                                 |
|--------------|----------------------------------------------------------------------|
| `/a`         | `Shift+A` から除外                                                   |
| `/v`         | `Shift+V` から除外（個別トグル用）                                   |
| `/r`         | `Shift+R` から除外                                                   |
| `/Compact`   | ワークフロー読み込み時に全ノードをコンパクトモードで起動 （ノードのどれか一つに記述があればいい） |
| `/R[n]`      | ちょうど n 個選択                                                    |
| `/R[n]-[m]`  | n〜m 個の間でランダム                                                |
| `/R-[m]`     | 0〜m 個                                                              |
| `/R-N-M`     | -N〜M 個（負の数＝外れ枠）                                           |
| `/C`         | **生成ごとに自動ランダム更新（永遠に）**                              |
| `/CMn` `/CMn-k` | 最大n回まで同じ内容で生成、それを超えるとランダムピックアップ         |
| `/T` `/TnMm-k` | 順番に有効化                                                         |

---

## カスタマイズ設定（web/index.js 内 CONFIG）

| 変数                        | デフォルト | 説明                     |
|-----------------------------|------------|--------------------------|
| `WEIGHT_STEP`               | `0.10`     | ウェイト増減単位         |
| `minWeight` / `maxWeight`   | `-1.0`〜`2.0` | ウェイト範囲             |
| `PROMPT_MAX_LENGTH_DISPLAY` | `30`       | 表示時の最大文字数       |
| `COMMENT_FONT_SCALE`        | `0.8`      | コメント文字サイズ       |

---

## インストールとアップデート

### 1. ComfyUI Manager から（推奨）
Manager → "Install Custom Nodes" → `PromptSwitch` で検索 → インストール → 再起動

### 2. 手動インストール
  
ComfyUI/custom_nodes フォルダで実行  
git clone https://github.com/Boba-svg/ComfyUI-PromptSwitch.git  
  
### 3. アップデート  
  
同フォルダで実行  
  
git pull  

---  
  
## アップデート履歴（抜粋）

| 日付         | 内容                                                                                   |
|--------------|----------------------------------------------------------------------------------------|
| 2025/11/07   | `/C` タグ初実装                                                                        |
| 2025/11/08   | `/C` 挙動修正（生成前1回のみ）                                                         |
| 2025/11/10   | 負数外れ枠 `/R-N-M` 実装                                                               |
| 2025/11/14   | `/T` タグ実装                                                                          |
| 2025/11/15   | **`/C` 完全決定版**（生成後も残る・毎回ランダム・Cキーだけで完結）                     |
| **2025/11/22** | **`/Compact` タグ追加**（ワークフロー読み込み時に全ノードをコンパクトモードで起動）     |

---

## クレジット
このノードは **kambara 氏の ComfyUI-PromptPalette** をフォークし、大幅に拡張したものです。

## ライセンス
MIT License
