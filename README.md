# ComfyUI-PromptSwitch ✨ プロンプト作業を劇的に高速化！✨

**プロンプトのON/OFF切り替えやウェイト調整**を、まるでチェックリストのように直感的に行えるカスタムノードです。

***

🎉 Git Hubで公開された「PromptSwitch」へようこそ！

これは、**Prompt Palette の優れたアイデア**をベースに、**プロンプト管理とノード操作の快適さ**を追求して大幅に改善したバージョンです。

このノードには、以下のマークを使用し、機能の起源を区別しています。

* **⚡️ [Original]**: Prompt Paletteから受け継いだ、核となる基本的な機能
* **🆕 [Switch]**: PromptSwitchで独自に追加・改善された機能

***

## 🚀 PromptSwitch の主な機能

このカスタムノードのすごいところは、プロンプトの各行を独立して操作できる点、そして細かいカスタマイズができる点にあります。

### 機能説明と操作イメージ 🎮




### 1. 超直感的！インタラクティブなプロンプト管理

ノードが非編集モードのとき、プロンプトの各行が「チェックリスト」のように表示されます。

* **⚡️ [Original] 行のON/OFF切り替え（活性化/コメントアウト）** 🟢/⚫
    * ノード内のテキスト行を**クリック**するだけで、そのプロンプトを瞬時に有効化/無効化できます。試行錯誤が超スムーズに！
* **⚡️ [Original] プロンプトウェイトの微調整が簡単！** ⚖️
    * 各行の右にある **`[+]` / `[-]` ボタン**をクリックするだけで、ウェイトを **`CONFIG.WEIGHT_STEP` (デフォルト 0.10)** 単位でサクサク増減できます。ウェイト値はボタンの隣に表示されます。
* **⚡️ [Original] 編集モード（Edit Mode）でも機能が有効** ✏️
    * **編集モードのまま**、通常のプロンプト入力ノードとして機能し続けます。編集と実行をシームレスに行き来できます。
* **🆕 [Switch] 空行に区切り線（Separator Line）を描画** ✅
    * プロンプトブロックの視認性を高めるため、**空行**に対して細い横線が自動で描画されます。（オリジナルのちょっとした不満点を解消！）
* **🆕 [Switch] 表示がとにかく見やすい！視覚的な大改善** 👀
    * **テキストの自動省略**：行の文字数が多すぎる場合、ノードの見た目が崩れないように自動的に省略表示されます。
    * **コメントの見やすさ調整**：コメントアウトされた行（`//` で始まる行）について、以下の視覚的な調整が可能です。
        * **コメント記号 `//` は非表示になります**。
        * コメントの色や**フォントサイズを最適化**し、メインのプロンプトがより際立つように調整されています。

### 2. ノードのモード切り替え

* **✏️ 編集モード（Edit Mode）**
    * **`F2`** または **`E` キー**、または **ノード本体の左・下・右枠をダブルクリック**で、通常のテキスト入力エリアを表示/非表示に切り替えられます。
* **🆕 [Switch] ミニマムモード（Visible/Invisible）**
    * **`V` キー**で、選択中のノードの表示を切り替え！
        * **通常モード（展開）**: 全ての行を表示し、プロンプト編集に集中できます。
        * **コンパクトモード（最小化）**: 無効な行を非表示にして、ノードの高さを最小限に抑えます。キャンバスを広く使いたい時に便利！

***

## 🚀 爆速作業のためのショートカット機能 💨

作業のスピードアップを目的とした、強力なキーボードショートカットを提供します。（**注: これらは全てPromptSwitchで独自に追加・強化された機能です！**）

> ⚠️ **画像に関する注意**: 上部の機能説明画像は古いバージョンに基づいています。特にRキーの機能は、このセクションに記載されている**ランダムピックアップ機能**に更新されています。

| ショートカット | 機能 | 説明 |
| :--- | :--- | :--- |
| **A** | **まとめてON/OFF** | 選択中のノードの**全てのプロンプト行**を一括でON/OFF切り替え（トグル）！ |
| **Shift + A** | **全ノード強制無効化** 🚨 | **キャンバス上の全てのPromptSwitchノード**のプロンプトを、一括で**強制的にコメントアウト**します。**【除外タグ: `/a`】** |
| **V** | **コンパクトモード切替** | 選択中のノードの**無効なプロンプト行**の表示/非表示（コンパクト ⇔ 通常）を切り替え！ |
| **Shift + V** | **全ノード表示モード一括変更** | **キャンバス上の全PromptSwitchノード**の表示を、一括で**コンパクト ⇔ 通常**に切り替え！**【除外タグ: `/v`】** |
| **W** | **ウェイト一発リセット** | 選択中のノード内の**全てのウェイト**を、一括で **`1.0`** にリセット（括弧を削除）します。|
| **R** | **ランダムピックアップ** ✨ | 選択中のノード内のプロンプトを、**空行で区切られたセクション**からランダムで有効化します。**タグ指定により有効化数が可変**します。|
| **Shift + R** | **全ノードランダムピックアップ** 🎲 | **キャンバス上の全PromptSwitchノード**に対して、上記のランダムピックアップを一括実行します。**【除外タグ: `/r`】**|
| **F1** | **ヘルプを表示** | このノードの主要なショートカット一覧と、**除外タグのルール**をすぐに確認できます。|

> **📌 除外タグのルールとランダムピックアップ機能拡張 【重要】**
> * 一括操作からノードを除外したい場合や、ランダムピックアップの挙動を変更したい場合は、**ノードタイトルの末尾**に以下のタグを付けてください。
> * **`/a`**: `Shift+A` の一括無効化から除外。
> * **`/v`**: `Shift+V` の一括表示切替から除外。
> * **`/r`**: `Shift+R` の一括ランダムピックアップから除外。（**バイパス/ミュートノードも除外**されます）
> * **`/R[数]`**: **Rキー単体および Shift+R の機能**の動作を変更します。空行で区切られた各セクションから有効化する要素の数を制御します。
> * **`/avR0-3`** のように、複数のタグを組み合わせて指定することも可能です。
>
> **【ランダムピックアップ数制御 (`/R[数]`) の詳細】**
> | タグの形式 | 有効化する要素の数 | 例と動作 |
> | :--- | :--- | :--- |
> | **`/R[n]`** | **ちょうど $n$ 個** | `/R2` $\rightarrow$ ちょうど**2個**の要素を有効化。 |
> | **`/R[n]-[m]`** | **$n$ から $m$ 個** | `/R0-3` $\rightarrow$ **0個から3個**をランダムで有効化。 |
> | **`/R-[m]`** | **1から $m$ 個** | `/R-4` $\rightarrow$ **1個から4個**をランダムで有効化。 |
> | **`/R[m]-[n]`** | **$n$ から $m$ 個** | `/R4-1` $\rightarrow$ **1個から4個**をランダムで有効化。（大小順は考慮しない） |

***

## ⚡️ [Original] プロンプト管理をテキストエディターで出来る事による強力な応用性

Prompt Paletteのテキストエディター機能は、プロンプト編集に強力な応用性をもたらします。その一部をご紹介します。

### 1. 他の方の作ったプロンプトの導入のしやすさ

プロンプトをコピー後、別途エディターで「カンマ」を「カンマ＋改行文字」に置換して本ノードに貼り付けると、**即座にすべての要素がリスト化**されます。

### 2. プロンプト紹介サイト＋チャットAIを活用する活用法

プロンプト紹介サイトやチャットAIを活用することで、労せずに強力なプロンプトリストを入手し、再検索の手間を省くことができます。

1.  チャットAIの入力画面にまず、以下の指示文を打ちます。（エンターはまだ押さないで）
    ```
    こちらの中のプロンプトとそれに対するコメントを「プロンプト // コメント」という形で抽出してほしい。カテゴリが変わったら空白行を入れて、一回のコピーボタンですむようにまとめて。
    ```
2.  そしてプロンプト紹介サイトの内容を `Ctrl + A` → `Ctrl + C` でコピーし、上記の入力のあとに貼り付けをしてエンター。
3.  チャットAIは「プロンプト // コメント」の形でそのページのプロンプトをリスト化し、コピーボタンまで用意してくれるでしょう。
4.  それをPromptSwitchに貼り付ければ、**即強力なプロンプトリストを入手**でき、忘れるたびにプロンプト紹介サイトを検索する手間から逃れることができます。

***

## 🔧 カスタマイズ大歓迎！設定変数リスト

`web/index.js` の `CONFIG` オブジェクトを直接編集することで、ノードの細かい振る舞いを調整できます。

| 変数名 | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `WEIGHT_STEP` | `0.10` | ウェイト増減ボタン (`[+]`/`[-]`) で増減する単位量を設定します。|
| `minWeight` | `-1.0` | 最小ウェイト値を設定します。 |
| `maxWeight` | `2.0` | 最大ウェイト値を設定します。 |
| `COMMENT_FONT_SCALE` | `0.8` | コメント行のフォントサイズを、プロンプトのフォントサイズに対する比率で指定します。 |
| `PROMPT_MAX_LENGTH_DISPLAY` | `30` | ノード表示時に省略せずに表示するプロンプトの最大文字数を指定します。 |
| `COLOR_PROMPT_ON` | `"#FFF"` | 有効なプロンプトのテキスト色。 |
| `COLOR_COMMENT_ON` | `"#ADD8E6"` | 有効なプロンプトに付随するコメントのテキスト色。 |
| `COLOR_PROMPT_OFF` | `"#AAAAAA"` | 無効なプロンプト（コメントアウトされた行）のテキスト色。 |
| `COLOR_COMMENT_OFF` | `"#AAAAAA"` | 無効なプロンプトに付随するコメントのテキスト色。 |

> ⚠️ **注意**: `web/index.js` のコードを元に、存在しない設定項目（`ENABLE_SHIFT_A_CONFIRMATION`、`ENABLE_R_KEY_RESET`、`ENABLE_DBLCLICK_TOGGLE`、`COMMENT_COLOR`、`COMMENT_FONT_SIZE`）は削除し、実際の変数名（`WEIGHT_STEP`、`minWeight`、`maxWeight`、`COMMENT_FONT_SCALE`、`PROMPT_MAX_LENGTH_DISPLAY`、カラーコード）に合わせて調整しました。

***

## 🛠️ インストールとアップデート方法

現在、**ComfyUI Managerへの登録準備中**です！それまでは、以下のGitコマンドを使った手動での管理をお願いします🙇‍♂️。

### 1. 手動インストール手順 (Git Clone)

1.  ComfyUIがインストールされているフォルダ内の **`custom_nodes` フォルダ**へ移動します。

    ```bash
    cd /path/to/ComfyUI/custom_nodes
    ```

2.  以下のコマンドでリポジトリをクローン（ダウンロード）します。

    ```bash
    git clone https://github.com/Boba-svg/ComfyUI-PromptSwitch.git
    ```

3.  ComfyUIを再起動すれば完了です！

### 2. アップデート手順 (Git Pull) 🆕

最新の機能や修正を取り込む際は、以下の手順を実行してください。

1.  ComfyUIのプロセスを完全に終了します。
2.  ComfyUIがインストールされているフォルダ内の **`custom_nodes` フォルダ**へ移動します。
3.  `ComfyUI-PromptSwitch` フォルダへ移動します。

    ```bash
    cd /path/to/ComfyUI/custom_nodes/ComfyUI-PromptSwitch
    ```

4.  以下のコマンドで最新の変更を取得します。

    ```bash
    git pull
    ```
    （※もしファイルの上書きに関するエラーが出た場合は、一時ファイルを削除するか、`git reset --hard` でローカルの変更を破棄してください。）

5.  ComfyUIを再起動すればアップデート完了です！

***

## 💡 使用方法

1.  ノード検索メニュー（右クリックまたは`Ctrl + Space`）から、**ユーティリティ（utils）**カテゴリなどからノードを呼び出します。
2.  ノードにフォーカスを合わせて**`F1`キー**を押すと、ノードの詳細なヘルプが表示されます。

***
## 💡 アップデート履歴
1.  25/10/16 公開
2.  25/10/17 **末尾タグによる除外機能追加**：Shift+A (`/a`) / Shift+V (`/v`) の一括操作から特定のノードを除外する機能を追加。シンプル化のため、ノードタイトル先頭の `※` や `-` による除外機能は削除されました。
3.  25/10/20 weightを戻したときに実データにウエイト表記が残ってしまうのを修正
4.  25/10/20 weightの操作時にカンマのあるパターン、カンマのないパターンで動きを統一
5.  25/10/20 機能のオンオフを操作するフラグ関連の処理を全部撤廃
6.  25/10/30 **Rキーをランダムピックアップに変更**：Rキー単独で選択ノードのランダムピックアップ、Shift+Rで全ノードの一括ランダムピックアップを導入。既存のウェイトリセット機能は**Wキー**に移動。
7.  25/10/30 **ランダムピックアップの拡張機能を追加**：ノードタイトルの末尾に `/R[数]` タグを指定することで、ランダム有効化する要素の数を複数・範囲指定できるように変更。

***

## 💡 次の更新予定
1.  空白行のみの場合は改行文字もプロンプトに入れない
2.  プロンプトの繋ぎ、およびプロンプトの最後に改行を入れないモードを用意する　⇒　出力プロンプトを綺麗にしたい人むけ　（自分は今の方が視認性がよくて好き）
3.  シフト＋Eで全てのノードをエディットモードで開くを導入　⇒　ブラウザの検索機能に引っかかるようになる
***

## 🌟 クレジット (Credit) / 感謝！ 🙏

このカスタムノード（ComfyUI-PromptSwitch）は、**kambara**氏によって開発された優れたプロジェクト [`ComfyUI-PromptPalette`](https://github.com/kambara/ComfyUI-PromptPalette) のアイデアをフォークし、大幅に機能拡張したものです。

オリジナルの作者とプロジェクトに心から感謝いたします。

***

## 📝 ライセンス

このプロジェクトは、オリジナルと同じく **MITライセンス**の下で公開されています。

詳細はリポジ
